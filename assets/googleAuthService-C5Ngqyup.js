const l={client_id:"876709571626-7mo1vufj60io8ddaa8lb99e2bpi2n3ib.apps.googleusercontent.com"};class d{constructor(){this.isInitialized=!1,this.initPromise=null}async init(){if(!this.isInitialized){if(this.initPromise)return this.initPromise;this.initPromise=new Promise((e,i)=>{if(window.google)this.setupGoogleAuth(),e();else{const t=document.createElement("script");t.src="https://accounts.google.com/gsi/client",t.async=!0,t.defer=!0,t.onload=()=>{this.setupGoogleAuth(),e()},t.onerror=()=>i(new Error("Failed to load Google Identity Services")),document.head.appendChild(t)}}),await this.initPromise,this.isInitialized=!0}}setupGoogleAuth(){window.google&&window.google.accounts.id.initialize({client_id:l.client_id,callback:this.handleCredentialResponse.bind(this),auto_select:!1,cancel_on_tap_outside:!0})}handleCredentialResponse(e){try{const i=this.parseJwt(e.credential);this.lastCredential=e.credential,this.lastUserInfo=i;const t=new CustomEvent("googleAuthSuccess",{detail:{credential:e.credential,userInfo:i}});window.dispatchEvent(t)}catch(i){console.error("Error handling Google credential:",i);const t=new CustomEvent("googleAuthError",{detail:{error:i.message}});window.dispatchEvent(t)}}parseJwt(e){try{const t=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),n=decodeURIComponent(atob(t).split("").map(function(o){return"%"+("00"+o.charCodeAt(0).toString(16)).slice(-2)}).join(""));return JSON.parse(n)}catch{throw new Error("Invalid token format")}}async renderSignInButton(e,i={}){return await this.init(),new Promise((t,n)=>{if(window.google){const o={type:"standard",theme:"outline",size:"large",text:"signup_with",shape:"rectangular",width:270,logo_alignment:"center"};try{const r=document.getElementById(e);if(!r){n(new Error(`Element with id "${e}" not found`));return}window.google.accounts.id.renderButton(r,{...o,...i});const s=new MutationObserver((g,c)=>{const a=r.querySelector("iframe")||r.querySelector('div[role="button"]');a&&(c.disconnect(),setTimeout(()=>t(a),100))});s.observe(r,{childList:!0,subtree:!0}),setTimeout(()=>{s.disconnect(),t(null)},3e3)}catch(r){n(r)}}else n(new Error("Google Identity Services not loaded"))})}async signInWithPopup(){return await this.init(),new Promise((e,i)=>{if(!window.google){i(new Error("Google Identity Services not loaded"));return}const t=n=>{try{const o=this.parseJwt(n.credential);e({credential:n.credential,userInfo:o})}catch(o){i(o)}};window.google.accounts.id.initialize({client_id:l.client_id,callback:t,auto_select:!1,cancel_on_tap_outside:!0}),window.google.accounts.id.prompt(n=>{(n.isNotDisplayed()||n.isSkippedMoment())&&i(new Error("Google Sign-In was cancelled or not displayed"))})})}getLastUserInfo(){return this.lastUserInfo}getLastCredential(){return this.lastCredential}convertToAppUser(e){return{id:`google_${e.sub}`,email:e.email,firstName:e.given_name||"",lastName:e.family_name||"",fullName:e.name||"",avatar:e.picture||"",isEmailVerified:e.email_verified||!1,provider:"google",googleId:e.sub,preferences:{notifications:!0,theme:"light"},createdAt:new Date().toISOString(),lastLoginAt:new Date().toISOString()}}signOut(){this.lastCredential=null,this.lastUserInfo=null,window.google&&window.google.accounts.id.disableAutoSelect()}}const h=new d;export{h as g};
